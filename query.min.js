!function(){function r(r){var t=[];for(var n in r){var e={};e[n]=r[n],t.push(e)}return t}function t(r){return""!==r&&null!=r}function n(r,t,n){return"number"==typeof t?t:n?n(r,t):r[t]}String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(r,t){return t=t||0,this.lastIndexOf(r,t)===t}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(r,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=r.length;var e=n.indexOf(r,t);return -1!==e&&e===t}});var e={satisfies:function(r,t,n){return"string"==typeof t?this.Query(t,n)(r):e.lhs._rowsatisfies(r,t,n)},Query:function(r,t){return function(n){return e.lhs._rowsatisfies(n,r,t)}},join:function(r,t,n,e){var i,u;return i="string"==typeof n?function(r){return r[n]}:n,e||(u=i),u="string"==typeof e?function(r){return r[n]}:e,r},query:function(r,t,n){if("string"==typeof n){var i=n;n=function(r,t){return r[i](t)}}var u=new e.Query(t,n);return r.filter(u)},lhs:{_rowsatisfies:function(r,t,n){for(var e in t)if(this[e]){if(!this[e](r,t[e],n))return!1}else{var i=n?n(r,e):r[e];if(!this.rhs._satisfies(i,t[e],r,n))return!1}return!0},$count:function(r,t,n){var i=t.$constraints.map(function(t){return e.satisfies(r,t,n)}).filter(function(r){return r}).length;return this.rhs._satisfies(i,t.$constraint)},$same:function(r,n,e){if(Array.isArray(n)){var i=n.map(function(t){return e?e(r,t):r[t]}).filter(t);if(0==i.length)return!0;for(var u=0;u<i.length;u++)if(i[u]!=i[0])return!1;return!0}throw Error("$same requires array value ")},$not:function(r,t,n){return!this._rowsatisfies(r,t,n)},$or:function(t,n,e){Array.isArray(n)||(n=r(n));for(var i=0;i<n.length;i++)if(this._rowsatisfies(t,n[i],e))return!0;return!1},$and:function(t,n,e){Array.isArray(n)||(n=r(n));for(var i=0;i<n.length;i++)if(!this._rowsatisfies(t,n[i],e))return!1;return!0},$nor:function(r,t,n){return!this.$or(r,t,n)},$where:function(r,t){throw Error("$where constraints no longer supported")},$expr:function(r,t,n){var e=!0;for(var i in t)if(this.agg[i]){var u=t[i],s=Number(r[u[0].slice(1,u[0].length)]),o=Number(r[u[1].slice(1,u[1].length)]),f=this.agg[i](r,[s,o],n);e=e&&f}return e},agg:{$lt:function(r,t,e){if(2!=t.length)throw Error("$lt requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);if(console.log({val1:i,val2:u}),"number"!=typeof i||"number"!=typeof u)throw Error("Both operands of $lt must be numbers");return i<u},$eq:function(r,t,e){if(2!=t.length)throw Error("$eq requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);return i===u},$ne:function(r,t,e){if(2!=t.length)throw Error("$ne requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);return i!==u},$lte:function(r,t,e){if(2!=t.length)throw Error("$lte requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);if("number"!=typeof i||"number"!=typeof u)throw Error("Both operands of $lte must be numbers");return i<=u},$gt:function(r,t,e){if(2!=t.length)throw Error("$gt requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);if("number"!=typeof i||"number"!=typeof u)throw Error("Both operands of $gt must be numbers");return i>u},$gte:function(r,t,e){if(2!=t.length)throw Error("$gte requires exactly two operands");var i=n(r,t[0],e),u=n(r,t[1],e);if("number"!=typeof i||"number"!=typeof u)throw Error("Both operands of $gte must be numbers");return i>=u},$sum:function(r,t,e){for(var i=0,u=0;u<t.length;u++){var s=n(r,t[u],e);s==+s&&(i+=+s)}return i},$min:function(r,t,e){for(var i=Infinity,u=0;u<t.length;u++){var s=n(r,t[u],e);s==+s&&(s=+s),s<i&&(i=s)}return i},$max:function(r,t,e){for(var i=-1/0,u=0;u<t.length;u++){var s=n(r,t[u],e);s==+s&&(s=+s),s>i&&(i=s)}return i},$divide:function(r,t,e){var i=n(r,t[0],e),u=n(r,t[1],e);return i/u},$same:function(r,n,e){if(Array.isArray(n)){var i=n.map(function(t){return e?e(r,t):r[t]}).filter(t);if(0==i.length)return!0;for(var u=0;u<i.length;u++)if(i[u]!=i[0])return!1;return!0}throw Error("$same requires array value ")}},rhs:{$cb:function(r,t){return t(r)},_satisfies:function(r,t,n,e){if(t===r)return!0;if("string"==typeof r&&("["===r[0]||"{"===r[0]))try{r=JSON.parse(r)}catch(i){}if(t instanceof RegExp)return this.$regex(r,RegExp(t));if(Array.isArray(t))return this.$in(r,t);if(t&&"object"==typeof t){if(t instanceof Date)return this.$eq(r,t.getTime());if(t.$regex)return this.$regex(r,RegExp(t.$regex,t.$options));if(t instanceof RegExp)return this.$regex(r,t);for(var u in t){if(!this[u])return this.$eq(r,t,n,e);if(!this[u](r,t[u],n,e))return!1}return!0}if(""===t||null==t)return this.$null(r);if(!Array.isArray(r))return this.$eq(r,t,n,e);for(var s=0;s<r.length;s++)if(this.$eq(r[s],t))return!0;return!1},$eq:function(r,t){if(r===t)return!0;if(Array.isArray(r)){for(var n=0;n<r.length;n++)if(this.$eq(r[n],t))return!0;return!1}if(null==t||""===t)return this.$null(r);if(null===r||""===r||void 0===r)return!1;if(!(r instanceof Date))return r==t;if(t instanceof Date)return r.getTime()==t.getTime();if("number"==typeof t)return r.getTime()==t;if("string"==typeof t)return r.getTime()==new Date(t).getTime()},$exists:function(r,t){return void 0!=r==(t&&!0)},$deepEquals:function(r,t){return"undefined"==typeof _||void 0===_.isEqual?JSON.stringify(r)==JSON.stringify(t):_.isEqual(r,t)},$not:function(r,t){return!this._satisfies(r,t)},$ne:function(r,t){return!this._satisfies(r,t)},$nor:function(r,t){return!this.$or(r,t)},$and:function(r,t){if(!Array.isArray(t))throw Error("Logic $and takes array of constraint objects");for(var n=0;n<t.length;n++)if(!this._satisfies(r,t[n]))return!1;return!0},$or:function(r,t){Array.isArray(r)||(r=[r]);for(var n=0;n<r.length;n++)for(var e=0;e<t.length;e++)if(this._satisfies(r[n],t[e]))return!0;return!1},$null:function(r){if(""===r||null==r)return!0;if(!Array.isArray(r))return!1;if(0==r.length)return!0;for(var t=0;t<r.length;t++)if(!this.$null(r[t]))return!1;return!0},$in:function(r,t){if(!Array.isArray(t))throw Error("$in requires an array operand");var n=!1;Array.isArray(r)||(r=[r]);for(var e=0;e<r.length;e++)for(var i=r[e],u=0;u<t.length;u++)if(t.indexOf(i)>=0||this._satisfies(i,t[u])){n=!0;break}return n},$likeI:function(r,t){return String(r).toLowerCase().indexOf(t)>=0},$like:function(r,t){return r.indexOf(t)>=0},$startsWith:function(r,t){return!!r&&r.startsWith(t)},$endsWith:function(r,t){return!!r&&r.endsWith(t)},$elemMatch:function(r,t){if(!Array.isArray(r))return e.lhs.rhs._satisfies(r,t);for(var n=0;n<r.length;n++)if(e.lhs.rhs._satisfies(r[n],t))return!0;return!1},$contains:function(r,t){return r.indexOf(t)>=0},$nin:function(r,t){return!this.$in(r,t)},$regex:function(r,t){if(!Array.isArray(r))return t.test(r);for(var n=0;n<r.length;n++)if(RegExp(t).test(r[n]))return!0},$gte:function(r,t){if(Array.isArray(r)){var n=this;return r.every(function(r){return n.$gte(r,t)})}return!this.$null(r)&&r>=this.resolve(t)},$gt:function(r,t){if(Array.isArray(r)){var n=this;return r.every(function(r){return n.$gt(r,t)})}return!this.$null(r)&&r>this.resolve(t)},$lt:function(r,t){if(Array.isArray(r)){var n=this;return r.every(function(r){return n.$lt(r,t)})}return!this.$null(r)&&r<this.resolve(t)},$lte:function(r,t){if(Array.isArray(r)){var n=this;return r.every(function(r){return n.$lte(r,t)})}return!this.$null(r)&&r<=this.resolve(t)},$before:function(r,t){return"string"==typeof t&&(t=Date.parse(t)),"string"==typeof r&&(r=Date.parse(r)),this.$lte(r,t)},$after:function(r,t){return"string"==typeof t&&(t=Date.parse(t)),"string"==typeof r&&(r=Date.parse(r)),this.$gte(r,t)},$type:function(r,t){return typeof r==t},$all:function(r,t){throw Error("$all not implemented")},$size:function(r,t){return"object"==typeof r&&(r.length==t||Object.keys(r).length==t)},$mod:function(r,t){return r%t[0]==t[1]},$equal:function(){return this.$eq(arguments)},$between:function(r,t){return this._satisfies(r,{$gt:t[0],$lt:t[1]})},resolve:function(r){return"object"==typeof r&&r.$date?Date.parse(r.$date):r}}}};e.undot=function(r,t){for(var n=t.split("."),e=r,i=0;i<n.length;i++)e=e[n[i]];return e},e.undotArray=function(r,t){for(var n=t.split("."),i=r,u=0;u<n.length;u++){var t=n[u];if(Array.isArray(i)){var s=parseInt(t);isNaN(s)?(Array.isArray(i[0])&&(i=i.reduce(function(r,t){return r.concat(t)},[])),i=i.map(function(r){return e.undotArray(r,t)})):i=i[s]}else i=i[t]}return i},e.lhs.rhs.$equal=e.lhs.rhs.$eq,e.lhs.rhs.$any=e.lhs.rhs.$or,e.lhs.rhs.$all=e.lhs.rhs.$and,e.valueSatisfiesConstraint=function(r,t){return this.lhs.rhs._satisfies(r,t)},RegExp.prototype.toJSON=RegExp.prototype.toString,"undefined"!=typeof module?module.exports=e:"undefined"!=typeof define&&define.amd?define("query",[],function(){return e}):"undefined"!=typeof window?window.Query=e:GLOBAL.global&&(GLOBAL.global.Query=e)}(this);